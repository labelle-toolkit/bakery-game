name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout labelle-engine
        uses: actions/checkout@v4
        with:
          repository: labelle-toolkit/labelle-engine
          path: labelle-engine

      - name: Checkout labelle-tasks
        uses: actions/checkout@v4
        with:
          repository: labelle-toolkit/labelle-tasks
          path: labelle-tasks

      - name: Move dependencies to parent directory
        run: |
          mv labelle-engine ../labelle-engine
          mv labelle-tasks ../labelle-tasks
          ls -la ../

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build generator
        working-directory: ../labelle-engine
        run: zig build

      - name: Generate build files
        run: |
          # Run generator from the bakery-game directory
          ENGINE_PATH="${GITHUB_WORKSPACE}/../labelle-engine"

          # Run the generator binary directly (not through zig build)
          "${ENGINE_PATH}/zig-out/bin/labelle-generate" --engine-path="${ENGINE_PATH}"

          echo "=== Generated files ==="
          ls -la .labelle/
          ls -la .labelle/raylib_wasm/

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      - name: Populate emsdk sysroot
        run: |
          # Compile a minimal C file to force sysroot population
          echo 'int main() { return 0; }' > /tmp/test.c
          emcc /tmp/test.c -o /tmp/test.js

          # Find sysroot path
          SYSROOT="${EMSDK}/upstream/emscripten/cache/sysroot"
          echo "SYSROOT: $SYSROOT"
          ls -la "$SYSROOT/include/" | head -10

          # Export for subsequent steps
          echo "EMSDK_SYSROOT=$SYSROOT" >> $GITHUB_ENV

      - name: Build WASM
        working-directory: .labelle/raylib_wasm
        env:
          C_INCLUDE_PATH: ${{ env.EMSDK_SYSROOT }}/include
        run: |
          echo "C_INCLUDE_PATH: $C_INCLUDE_PATH"
          ls -la "$C_INCLUDE_PATH" | head -5

          # Pre-fetch dependencies to download emsdk
          echo "=== Pre-fetching dependencies ==="
          zig build --fetch-only -Dtarget=wasm32-emscripten -Doptimize=ReleaseSmall || true

          # Make emscripten scripts executable (they lose permissions when extracted from git archive)
          echo "=== Making emsdk scripts executable ==="
          find $GITHUB_WORKSPACE/.zig-cache -path "*/upstream/emscripten/emcc" -type f -exec chmod +x {} \; 2>/dev/null || true
          find $GITHUB_WORKSPACE/.zig-cache -path "*/upstream/emscripten/em++" -type f -exec chmod +x {} \; 2>/dev/null || true
          find $GITHUB_WORKSPACE/.zig-cache -path "*/upstream/emscripten/emcc.py" -type f -exec chmod +x {} \; 2>/dev/null || true
          find $GITHUB_WORKSPACE/.zig-cache -path "*/emsdk" -name "emsdk" -type f -exec chmod +x {} \; 2>/dev/null || true
          find $GITHUB_WORKSPACE/.zig-cache -path "*/emsdk.py" -type f -exec chmod +x {} \; 2>/dev/null || true

          # Build WASM target with ReleaseSmall for production
          # Debug mode causes frame drops due to std.log overhead in WASM/JS console
          echo "=== Building WASM ==="
          zig build -Dtarget=wasm32-emscripten -Doptimize=ReleaseSmall

          # List output
          echo "=== Build output ==="
          ls -la zig-out/web/

      - name: Prepare deployment
        run: |
          mkdir -p dist

          # Copy WASM build artifacts from new generator location
          cp -r .labelle/raylib_wasm/zig-out/web/* dist/

          # Rename bakery_game.html to index.html
          if [ -f "dist/bakery_game.html" ]; then
            mv dist/bakery_game.html dist/index.html
          fi

          # Create 404 redirect
          echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0;url=/bakery-game/"></head></html>' > dist/404.html

          echo "=== Deployment files ==="
          ls -la dist/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
