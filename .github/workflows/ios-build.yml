name: iOS Build

on:
  push:
    branches: [main]
    paths:
      - '**.zig'
      - '**.zon'
      - 'project.labelle'
      - '.github/workflows/ios-build.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  ios-build:
    runs-on: macos-14  # macOS with Apple Silicon for iOS simulator

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout labelle-tasks (sibling dependency)
        uses: actions/checkout@v4
        with:
          repository: labelle-toolkit/labelle-tasks
          path: labelle-tasks

      - name: Checkout labelle-gfx (sibling dependency for engine)
        uses: actions/checkout@v4
        with:
          repository: labelle-toolkit/labelle-gfx
          path: labelle-gfx

      - name: Checkout labelle-engine (sibling dependency)
        uses: actions/checkout@v4
        with:
          repository: labelle-toolkit/labelle-engine
          path: labelle-engine

      - name: Move sibling dependencies to parent directory
        run: |
          mv labelle-tasks ../labelle-tasks
          mv labelle-gfx ../labelle-gfx
          mv labelle-engine ../labelle-engine
          ls -la ../

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install labelle-cli
        run: |
          curl -fsSL https://labelle.games/install.sh | bash
          echo "$HOME/.labelle/bin" >> $GITHUB_PATH

      - name: Show Xcode version
        run: |
          xcodebuild -version
          xcrun --sdk iphonesimulator --show-sdk-path

      - name: Create .labelle build files for CI
        run: |
          # Manually create .labelle directory with sibling paths.
          # This bypasses labelle generate which fetches v0.52.5 (has broken path deps).
          mkdir -p .labelle

          # Create build.zig.zon with sibling paths
          cat > .labelle/build.zig.zon << 'ZONEOF'
          .{
              .fingerprint = 0xf4d16b7c8c8e6415,
              .name = .bakery_game,
              .version = "0.1.0",
              .dependencies = .{
                  .@"labelle-engine" = .{
                      .path = "../../labelle-engine",
                  },
                  .@"labelle-tasks" = .{
                      .path = "../../labelle-tasks",
                  },
              },
              .paths = .{
                  "build.zig",
                  "build.zig.zon",
              },
          }
          ZONEOF

          # Create build.zig
          cat > .labelle/build.zig << 'ZIGEOF'
          const std = @import("std");

          pub const Backend = enum { raylib, sokol, sdl, bgfx, wgpu_native };
          pub const EcsBackend = enum { zig_ecs, zflecs };
          pub const GuiBackend = enum { none, raygui, microui, nuklear, imgui };

          pub fn build(b: *std.Build) void {
              const target = b.standardTargetOptions(.{});
              const optimize = b.standardOptimizeOption(.{});
              const is_ios = target.result.os.tag == .ios;

              const backend = b.option(Backend, "backend", "Graphics backend") orelse .raylib;
              const ecs_backend = b.option(EcsBackend, "ecs_backend", "ECS backend") orelse .zig_ecs;
              const gui_backend = b.option(GuiBackend, "gui_backend", "GUI backend") orelse .none;
              const physics_enabled = b.option(bool, "physics", "Enable physics") orelse false;

              const engine_dep = b.dependency("labelle-engine", .{
                  .target = target, .optimize = optimize,
                  .backend = backend, .ecs_backend = ecs_backend,
                  .gui_backend = gui_backend, .physics = physics_enabled,
              });
              const engine_mod = engine_dep.module("labelle-engine");

              const labelle_tasks_dep = b.dependency("labelle-tasks", .{
                  .target = target, .optimize = optimize,
                  .backend = backend, .ecs_backend = ecs_backend,
                  .gui_backend = gui_backend, .physics = physics_enabled,
              });
              const labelle_tasks_mod = labelle_tasks_dep.module("labelle_tasks");

              const exe_mod = b.createModule(.{
                  .root_source_file = b.path("../main.zig"),
                  .target = target, .optimize = optimize,
              });
              exe_mod.addImport("labelle-engine", engine_mod);
              exe_mod.addImport("labelle-tasks", labelle_tasks_mod);
              if (physics_enabled) {
                  exe_mod.addImport("labelle-physics", engine_dep.module("labelle-physics"));
              }

              const exe = b.addExecutable(.{ .name = "bakery_game", .root_module = exe_mod });
              if (is_ios) {
                  if (target.result.abi == .simulator) {
                      exe.addFrameworkPath(.{ .cwd_relative = "/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/Frameworks" });
                  } else {
                      exe.addFrameworkPath(.{ .cwd_relative = "/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk/System/Library/Frameworks" });
                  }
                  exe.linkFramework("Metal");
                  exe.linkFramework("MetalKit");
                  exe.linkFramework("UIKit");
                  exe.linkFramework("AudioToolbox");
                  exe.linkFramework("AVFoundation");
                  exe.linkFramework("Foundation");
                  exe.linkFramework("QuartzCore");
                  exe.linkSystemLibrary("objc");
              }
              b.installArtifact(exe);

              const run_cmd = b.addRunArtifact(exe);
              run_cmd.step.dependOn(b.getInstallStep());
              run_cmd.setCwd(b.path(".."));
              const run_step = b.step("run", "Run the game");
              run_step.dependOn(&run_cmd.step);
          }
          ZIGEOF

          echo "Created .labelle/build.zig and .labelle/build.zig.zon"
          ls -la .labelle/

      - name: Build for iOS Simulator
        run: |
          echo "::group::Building for iOS Simulator"
          ~/.labelle/bin/labelle ios build --simulator
          echo "::endgroup::"

      - name: Verify build artifacts
        run: |
          cd ios
          echo "Checking for build artifacts..."
          ls -la zig-out/bin/ 2>/dev/null || echo "zig-out/bin/ not found"

          # Check for either sim or device binary
          if [ -f "zig-out/bin/bakery_game_sim" ] || [ -f "zig-out/bin/bakery_game" ]; then
            echo "Build verified: binary exists"
            file zig-out/bin/bakery_game* 2>/dev/null || true
          else
            echo "::error::Binary not found - build may have failed"
            exit 1
          fi

      - name: Create iOS build summary
        run: |
          cd ios
          echo "## iOS Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "iOS Simulator build successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** aarch64-ios-simulator" >> $GITHUB_STEP_SUMMARY
          echo "**SDK:** $(xcrun --sdk iphonesimulator --show-sdk-path)" >> $GITHUB_STEP_SUMMARY
          echo "**Binary:** $(ls -lh zig-out/bin/bakery_game* 2>/dev/null | head -1 | awk '{print $5, $9}')" >> $GITHUB_STEP_SUMMARY
